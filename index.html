<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Psicologia - Sistema</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    h2 {
      margin-bottom: 20px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .hidden {
      display: none;
    }

    #historico {
      text-align: left;
    }

    .topo {
      background: #007bff;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
</head>
<body>
  <!-- LOGIN -->
  <div class="container" id="loginPage">
    <h2>Psicologia</h2>
    <p>Entre com sua conta Google</p>
    <button id="googleLogin">Entrar com Google</button>
  </div>

  <!-- FORMUL√ÅRIO -->
  <div class="container hidden" id="formPage">
    <div class="topo">Psicologia</div>
    <h2>Cadastro de Sess√£o</h2>
    <form id="form">
      <input type="text" name="nomePaciente" placeholder="Nome do Paciente" required>
      <input type="date" name="dataConsulta" required>
      <textarea name="historico" placeholder="Hist√≥rico" rows="3" required></textarea>
      <textarea name="evolucao" placeholder="Evolu√ß√£o" rows="3" required></textarea>
      <button type="submit">Salvar Sess√£o</button>
      <button type="button" id="verHistorico">Ver Hist√≥rico</button>
      <button type="button" id="sair">Sair</button>
    </form>
  </div>

  <!-- HIST√ìRICO -->
  <div class="container hidden" id="historicoPage">
    <div class="topo">Psicologia</div>
    <h2>Hist√≥rico de Sess√µes</h2>
    <div id="historico"></div>
    <button id="voltar">Voltar</button>
  </div>

  <script>
    // üîπ Configura√ß√£o Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCqXUb8Fq44x3utPPOYp8VBGh9q8k4-1xE",
      authDomain: "psico-17375.firebaseapp.com",
      projectId: "psico-17375",
      storageBucket: "psico-17375.appspot.com",
      messagingSenderId: "1007635106888",
      appId: "1:1007635106888:web:19a05353e41f9b0f5c8f0c"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const provider = new firebase.auth.GoogleAuthProvider();

    const loginPage = document.getElementById("loginPage");
    const formPage = document.getElementById("formPage");
    const historicoPage = document.getElementById("historicoPage");
    const form = document.getElementById("form");
    const historicoDiv = document.getElementById("historico");

    const scriptURL = "https://script.google.com/macros/s/AKfycbyGaa6EF45xEvUpiKAp0oKHJgtaSJDY0q33ff1L-ZlQ_nHI5rg34ZVR7DyjKNj-iAPMrQ/exec";

    // üîπ Login Google
    document.getElementById("googleLogin").addEventListener("click", () => {
      auth.signInWithPopup(provider)
        .then(result => {
          loginPage.classList.add("hidden");
          formPage.classList.remove("hidden");
        })
        .catch(err => alert("Erro no login: " + err.message));
    });

    // üîπ Logout
    document.getElementById("sair").addEventListener("click", () => {
      auth.signOut().then(() => {
        formPage.classList.add("hidden");
        loginPage.classList.remove("hidden");
      });
    });

    // üîπ Enviar dados √† planilha
    form.addEventListener("submit", e => {
      e.preventDefault();
      const data = new FormData(form);
      data.append("usuario", auth.currentUser ? auth.currentUser.email : "An√¥nimo");
      data.append("dataEnvio", new Date().toLocaleString("pt-BR"));

      fetch(scriptURL, { method: "POST", body: data })
        .then(() => {
          alert("‚úÖ Sess√£o salva com sucesso!");
          form.reset();
        })
        .catch(() => alert("‚ùå Erro ao enviar os dados."));
    });

    // üîπ Ver hist√≥rico
    document.getElementById("verHistorico").addEventListener("click", () => {
      formPage.classList.add("hidden");
      historicoPage.classList.remove("hidden");
      carregarHistorico();
    });

    // üîπ Voltar do hist√≥rico
    document.getElementById("voltar").addEventListener("click", () => {
      historicoPage.classList.add("hidden");
      formPage.classList.remove("hidden");
    });

    // üîπ Buscar dados no Apps Script
    function carregarHistorico() {
      fetch(scriptURL + "?action=read")
        .then(res => res.json())
        .then(dados => {
          if (!dados || dados.length === 0) {
            historicoDiv.innerHTML = "<p>Nenhum registro encontrado.</p>";
            return;
          }
          historicoDiv.innerHTML = dados.map(linha => `
            <p><b>${linha.nomePaciente}</b><br>
            Data: ${linha.dataConsulta}<br>
            Hist√≥rico: ${linha.historico}<br>
            Evolu√ß√£o: ${linha.evolucao}</p><hr>
          `).join("");
        })
        .catch(() => historicoDiv.innerHTML = "<p>Erro ao carregar hist√≥rico.</p>");
    }
  </script>
</body>
</html>
