<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prontu√°rio Psicol√≥gico ‚Äî Dashboard</title>

  <!-- Fonts &amp; Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&amp;display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase (compat for your current usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --sidebar-bg:#f8f9fa;
      --accent: linear-gradient(90deg,#6d28d9,#4f46e5);
      --panel-bg:#ffffff;
      --surface:#f1f3f5;
      --card:#ffffff;
      --muted:#64748b;
      --text-dark:#1e293b;
      --white:#ffffff;
      --border:#e2e8f0;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:#f1f5f9;color:var(--text-dark);-webkit-font-smoothing:antialiased}

    .app {
      display:flex;
      height:100vh;
      width:100%;
      overflow:hidden;
    }

    /* Sidebar */
    .sidebar {
      width:260px;
      min-width:220px;
      background: linear-gradient(180deg,#ffffff 0%, #f8f9fa 100%);
      color:var(--text-dark);
      padding:22px 16px;
      display:flex;
      flex-direction:column;
      gap:18px;
      border-right:1px solid var(--border);
      box-shadow: 2px 0 8px rgba(0,0,0,0.04);
    }

    .brand {
      display:flex;
      align-items:center;
      gap:12px;
      padding-bottom:8px;
      margin-bottom:4px;
      border-bottom:1px solid var(--border);
    }
    .brand .logo {
      width:44px;height:44px;border-radius:10px;
      background:linear-gradient(135deg,#6d28d9,#4f46e5);
      display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 6px 18px rgba(79,70,229,0.18);
      color:#fff;
    }
    .brand h3{margin:0;font-size:15px;font-weight:600;color:var(--text-dark)}
    .brand p{margin:0;font-size:12px;color:var(--muted)}

    /* Nav */
    .nav {
      display:flex;flex-direction:column;gap:8px;margin-top:6px;
    }

    .nav button {
      display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;border:none;background:transparent;color:var(--text-dark);cursor:pointer;text-align:left;font-weight:500;
      transition: all .18s ease;
    }
    .nav button:hover { background: rgba(109,40,217,0.08); transform: translateY(-2px); }
    .nav button.active {
      background: linear-gradient(90deg,rgba(109,40,217,0.1) 0%, rgba(79,70,229,0.08) 100%);
      box-shadow: 0 4px 12px rgba(79,70,229,0.1);
      transform: none;
      color:#6d28d9;
    }
    .nav .material-icons { font-size:20px;color: #6d28d9 }

    .sidebar-footer { margin-top:auto; display:flex;flex-direction:column;gap:8px }
    .small-btn { padding:8px 10px; border-radius:8px; border:none; background:transparent; color:var(--muted); cursor:pointer; display:flex; align-items:center; gap:8px }
    .small-btn:hover { color:var(--text-dark); background: rgba(109,40,217,0.05) }

    /* Top header */
    .topbar {
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:0 20px;
      border-bottom:1px solid var(--border);
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .top-left {display:flex;align-items:center;gap:12px}
    .page-title { font-size:18px; font-weight:600; color:var(--text-dark) }
    .user-actions { display:flex; align-items:center; gap:12px }

    .avatar {
      width:40px;height:40px;border-radius:10px;background:linear-gradient(90deg,#6d28d9,#4f46e5);display:flex;align-items:center;justify-content:center;font-weight:600;color:#fff;
      box-shadow:0 6px 18px rgba(79,70,229,0.15)
    }

    /* Workspace / main content */
    .workspace {
      flex:1;
      display:flex;
      flex-direction:column;
      min-width:0;
      background: #f1f5f9;
    }

    .main-area {
      padding:20px;
      height:calc(100vh - 64px);
      overflow:auto;
    }

    .card {
      background: #ffffff;
      border-radius:12px;
      padding:20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border: 1px solid var(--border);
    }

    /* Grid */
    .grid {
      display:grid;
      gap:18px;
    }
    .grid.cols-2 { grid-template-columns: 1fr 380px; }
    .grid.cols-1 { grid-template-columns: 1fr; }

    /* Form fields */
    label{ display:block; font-size:13px; color:var(--muted); margin-top:12px; font-weight:600 }
    input, select, textarea {
      width:100%; padding:10px 12px; margin-top:6px; background:#fff; border:1px solid var(--border); color:var(--text-dark); border-radius:8px;
    }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:#6d28d9;
      box-shadow: 0 0 0 3px rgba(109,40,217,0.1);
    }
    textarea { min-height:110px; resize:vertical }
    textarea:read-only { background: #f8f9fa; cursor: not-allowed; opacity: 0.7; }

    .btn {
      display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;
      transition: all 0.2s ease;
    }
    .btn.primary {
      background: linear-gradient(90deg,#6d28d9,#4f46e5); color:#fff; box-shadow: 0 4px 12px rgba(79,70,229,0.2);
    }
    .btn.ghost { background: transparent; color:var(--muted); border:1px solid var(--border) }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(79,70,229,0.25); }

    .btn.toggle-btn {
      background: #f8f9fa;
      color: var(--text-dark);
      border: 1px solid var(--border);
    }
    .btn.toggle-btn.active {
      background: linear-gradient(90deg,#6d28d9,#4f46e5);
      color: #fff;
      border: 1px solid transparent;
    }

    .actions { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap: wrap; }

    .session-card { 
      background: #f8f9fa; 
      padding:12px; 
      border-radius:8px; 
      border-left:4px solid #6d28d9; 
      margin-bottom:12px; 
      color:var(--text-dark);
      font-size: 13px;
      line-height: 1.6;
    }

    /* REMOVIDO: .historico-preview e seus estilos filhos */

    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-compareceu { background: #d1fae5; color: #065f46; }
    .status-faltou { background: #fee2e2; color: #991b1b; }
    .status-reagendou { background: #fef3c7; color: #92400e; }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--text-dark);
      font-size: 13px;
    }
    td {
      font-size: 14px;
      color: var(--text-dark);
    }
    tr:hover {
      background: #f8f9fa;
    }

    /* Stats cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    .stat-card .label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-dark);
    }
    .stat-card.success .value { color: var(--success); }
    .stat-card.danger .value { color: var(--danger); }
    .stat-card.warning .value { color: var(--warning); }

    /* Chart container */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }

    /* Responsive */
    @media (max-width:980px) {
      .sidebar { width:64px; min-width:64px; padding:12px }
      .brand h3, .brand p { display:none }
      .nav button span.label { display:none }
      .grid.cols-2 { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
    }
    @media (max-width:640px) {
      .topbar { padding:8px 12px }
      .main-area { padding:12px }
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">PS</div>
        <div>
          <h3>Prontu√°rio</h3>
          <p>Clinica ‚Ä¢ Painel</p>
        </div>
      </div>

      <nav class="nav" role="navigation" aria-label="menu lateral">
        <button class="nav-btn active" data-tab="paciente" id="btn-paciente">
          <span class="material-icons">person</span>
          <span class="label">Paciente</span>
        </button>

        <button class="nav-btn" data-tab="sessao" id="btn-sessao">
          <span class="material-icons">forum</span>
          <span class="label">Sess√£o</span>
        </button>

        <button class="nav-btn" data-tab="historico" id="btn-historico">
          <span class="material-icons">history</span>
          <span class="label">Hist√≥rico</span>
        </button>

        <button class="nav-btn" data-tab="frequencia" id="btn-frequencia">
          <span class="material-icons">analytics</span>
          <span class="label">Frequ√™ncia</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        <button class="small-btn" onclick="toggleSidebar()" title="Alternar menu">
          <span class="material-icons">menu</span> <span class="label">Toggle</span>
        </button>

        <div style="height:8px"></div>
        <div style="font-size:12px;color:var(--muted)"><strong>Conectado:</strong><div id="userEmail" style="margin-top:6px;color:var(--muted)"> ‚Äî </div></div>
      </div>
    </aside>

    <!-- WORKSPACE -->
    <div class="workspace">
      <div class="topbar" id="topbar" style="display:none">
        <div class="top-left">
          <div class="page-title" id="pageTitle">Paciente</div>
        </div>

        <div class="user-actions">
          <div id="userName" style="font-weight:600;color:var(--text-dark); margin-right:6px"></div>
          <div class="avatar" id="userAvatar">U</div>
          <button class="btn ghost" onclick="logoutGoogle()" title="Sair">
            <span class="material-icons">logout</span>
            <span>Sair</span>
          </button>
        </div>
      </div>

      <div class="main-area" id="mainArea">
        <div id="carregando" style="text-align:center;padding:30px;color:var(--muted)">Carregando...</div>

        <!-- LOGIN CARD (quando deslogado) -->
        <div id="loginCard" style="display:none">
          <div class="card">
            <h2>Bem-vindo</h2>
            <p style="color:var(--muted)">Fa√ßa login com Google para acessar o prontu√°rio.</p>
            <div style="margin-top:18px">
              <button class="btn primary" onclick="loginGoogle()">
                <span class="material-icons">login</span> Entrar com Google
              </button>
            </div>
          </div>
        </div>

        <!-- SISTEMA -->
        <div id="appContent" style="display:none">
          <!-- Paciente Tab -->
          <section id="paciente" class="card tab active">
            <h3>Cadastro de Paciente</h3>
            <div class="grid cols-2" style="margin-top:14px">
              <div>
                <form id="formPaciente">
                  <label>Nome</label>
                  <input type="text" name="nome" required />

                  <label>Idade</label>
                  <input type="number" name="idade" required />

                  <label>Contato</label>
                  <input type="text" name="contato" />

                  <div style="margin-top:14px">
                    <button class="btn primary" type="submit"><span class="material-icons">person_add</span> Cadastrar</button>
                  </div>
                </form>
              </div>

              <div>
                <div class="card" style="padding:14px;background:#f8f9fa">
                  <strong style="color:var(--muted)">Dica r√°pida</strong>
                  <p style="margin-top:8px;color:var(--muted)">Use nomes completos para evitar duplicidade. Os pacientes cadastrados ficam dispon√≠veis na aba Sess√£o e Hist√≥rico.</p>
                </div>
              </div>
            </div>
          </section>

          <!-- Sess√£o Tab -->
          <section id="sessao" class="card tab" style="display:none">
            <h3>Registrar Sess√£o</h3>

            <!-- Bot√µes de Tipo de Consulta -->
            <div style="margin-top:14px; margin-bottom:20px;">
              <label style="margin-bottom:10px; display:block;">Tipo de Consulta</label>
              <div class="actions" style="margin:0;">
                <button type="button" class="btn toggle-btn active" id="btnPrimeiraConsulta" onclick="selecionarTipoConsulta('primeira')">
                  <span class="material-icons">person_add</span> Primeira Consulta
                </button>
                <button type="button" class="btn toggle-btn" id="btnAcompanhamento" onclick="selecionarTipoConsulta('acompanhamento')">
                  <span class="material-icons">update</span> Em Acompanhamento
                </button>
              </div>
              <p style="color:var(--muted); font-size:12px; margin-top:8px;" id="tipoConsultaInfo">
                Primeira consulta: hist√≥rico edit√°vel para novo paciente
              </p>
            </div>

            <div style="margin-top:14px">
              <form id="formSessao">
                <input type="hidden" name="tipoConsulta" id="tipoConsultaField" value="primeira" />

                <label>Paciente</label>
                <select name="nome" id="nomeSessao" required>
                  <option value="">Selecione</option>
                </select>

                <label>Data da Consulta</label>
                <input type="date" name="dataConsulta" required />

                <label>Status da Consulta</label>
                <select name="statusConsulta" required>
                  <option value="">Selecione</option>
                  <option value="Compareceu">Compareceu</option>
                  <option value="Faltou">Faltou</option>
                  <option value="Reagendou">Reagendou</option>
                </select>

                <label>Hist√≥rico Anterior</label>
                <textarea name="historico" id="historicoTextarea" placeholder="Hist√≥rico do paciente (edit√°vel em primeira consulta)"></textarea>

                <!-- REMOVIDO: div historicoPreview -->

                <label>Evolu√ß√£o da Sess√£o</label>
                <textarea name="evolucao" placeholder="Descreva o que foi trabalhado nesta sess√£o"></textarea>

                <div style="margin-top:14px">
                  <button class="btn primary" type="submit"><span class="material-icons">save</span> Salvar Sess√£o</button>
                </div>
              </form>
            </div>
          </section>

          <!-- Hist√≥rico Tab -->
          <section id="historico" class="card tab" style="display:none">
            <h3>Hist√≥rico Completo</h3>
            <div style="margin-top:14px">
              <label>Selecionar Paciente</label>
              <select id="historicoSelect">
                <option value="">Selecione</option>
              </select>
              <div style="margin-top:12px">
                <button class="btn primary" onclick="verHistorico()"><span class="material-icons">search</span> Ver Hist√≥rico</button>
                <button class="btn ghost" onclick="exportarPDF()"><span class="material-icons">picture_as_pdf</span> Exportar PDF</button>
              </div>
            </div>
            <div id="painel" style="margin-top:20px"></div>
          </section>

          <!-- Frequ√™ncia Tab -->
          <section id="frequencia" class="card tab" style="display:none">
            <h3>Frequ√™ncia de Consultas</h3>

            <div style="margin-top:14px; display:flex; gap:12px; flex-wrap:wrap;">
              <div>
                <label>Paciente</label>
                <select id="frequenciaPaciente" onchange="atualizarFrequencia()">
                  <option value="">Todos os pacientes</option>
                </select>
              </div>
              <div>
                <label>M√™s</label>
                <select id="frequenciaMes" onchange="atualizarFrequencia()">
                  <option value="">Todos</option>
                  <option value="1">Janeiro</option>
                  <option value="2">Fevereiro</option>
                  <option value="3">Mar√ßo</option>
                  <option value="4">Abril</option>
                  <option value="5">Maio</option>
                  <option value="6">Junho</option>
                  <option value="7">Julho</option>
                  <option value="8">Agosto</option>
                  <option value="9">Setembro</option>
                  <option value="10">Outubro</option>
                  <option value="11">Novembro</option>
                  <option value="12">Dezembro</option>
                </select>
              </div>
              <div>
                <label>Ano</label>
                <select id="frequenciaAno" onchange="atualizarFrequencia()">
                  <option value="">Todos</option>
                </select>
              </div>
            </div>

            <div class="stats-grid" style="margin-top:20px">
              <div class="stat-card">
                <div class="label">Total de Consultas</div>
                <div class="value" id="statTotal">0</div>
              </div>
              <div class="stat-card success">
                <div class="label">Compareceu</div>
                <div class="value" id="statCompareceu">0</div>
              </div>
              <div class="stat-card danger">
                <div class="label">Faltou</div>
                <div class="value" id="statFaltou">0</div>
              </div>
              <div class="stat-card warning">
                <div class="label">Reagendou</div>
                <div class="value" id="statReagendou">0</div>
              </div>
            </div>

            <div class="chart-container">
              <canvas id="frequenciaChart"></canvas>
            </div>

            <table style="margin-top:20px">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Paciente</th>
                  <th>Status</th>
                  <th>Tipo</th>
                </tr>
              </thead>
              <tbody id="frequenciaTableBody">
                <tr><td colspan="4" style="text-align:center;color:var(--muted)">Selecione os filtros acima</td></tr>
              </tbody>
            </table>
          </section>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------------------------
       Config Firebase
       --------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyDGYBOcPMQNE-5gCZVrqDqsm_0JvvOKqbI",
      authDomain: "prontuario-psicologico-9a9e7.firebaseapp.com",
      projectId: "prontuario-psicologico-9a9e7",
      storageBucket: "prontuario-psicologico-9a9e7.firebasestorage.app",
      messagingSenderId: "1024867868086",
      appId: "1:1024867868086:web:f1bbd5e3cd1c7f3b4b0e2c"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    /* ---------------------------
       Apps Script URL
       --------------------------- */
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwOPpJzCFqKy3TlTpMEMfLqzEXqZe5JmFBWwTJGzL1Ygk2Yqjh-fxMPZBSxgTFgDqO-/exec';

    /* ---------------------------
       DOM refs
       --------------------------- */
    const carregando = document.getElementById('carregando');
    const formPaciente = document.getElementById('formPaciente');
    const formSessao = document.getElementById('formSessao');
    const nomeSessao = document.getElementById('nomeSessao');
    const historicoSelect = document.getElementById('historicoSelect');
    const painel = document.getElementById('painel');
    const historicoTextarea = document.getElementById('historicoTextarea');

    // REMOVIDO: const historicoPreview = document.getElementById('historicoPreview');

    const btnPaciente = document.getElementById('btn-paciente');
    const btnSessao = document.getElementById('btn-sessao');
    const btnHistorico = document.getElementById('btn-historico');
    const btnFrequencia = document.getElementById('btn-frequencia');

    let frequenciaChart = null;

    /* ---------------------------
       Nav / Tabs
       --------------------------- */
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.style.width = sidebar.style.width === '64px' ? '260px' : '64px';
    }

    function setActiveNav(btn) {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';
      const titles = {
        paciente: 'Paciente',
        sessao: 'Sess√£o',
        historico: 'Hist√≥rico',
        frequencia: 'Frequ√™ncia'
      };
      document.getElementById('pageTitle').textContent = titles[tabId] || 'Prontu√°rio';
    }

    /* ---------------------------
       Tipo de Consulta
       --------------------------- */
    let tipoConsultaSelecionado = 'primeira';

    function selecionarTipoConsulta(tipo) {
      tipoConsultaSelecionado = tipo;
      document.getElementById('tipoConsultaField').value = tipo;

      const btnPrimeira = document.getElementById('btnPrimeiraConsulta');
      const btnAcomp = document.getElementById('btnAcompanhamento');
      const infoText = document.getElementById('tipoConsultaInfo');

      if (tipo === 'primeira') {
        btnPrimeira.classList.add('active');
        btnAcomp.classList.remove('active');
        historicoTextarea.readOnly = false;
        historicoTextarea.placeholder = 'Hist√≥rico do paciente (edit√°vel em primeira consulta)';
        historicoTextarea.value = '';
        infoText.textContent = 'Primeira consulta: hist√≥rico edit√°vel para novo paciente';
      } else {
        btnPrimeira.classList.remove('active');
        btnAcomp.classList.add('active');
        historicoTextarea.readOnly = true;
        historicoTextarea.placeholder = 'Hist√≥rico ser√° carregado automaticamente ao selecionar o paciente';
        infoText.textContent = 'Acompanhamento: hist√≥rico anterior ser√° carregado automaticamente';

        // Se j√° tem paciente selecionado, carrega o hist√≥rico
        if (nomeSessao.value) {
          carregarHistoricoParaAcompanhamento(nomeSessao.value);
        }
      }
    }

    /* ---------------------------
       Carregar hist√≥rico para acompanhamento
       --------------------------- */
    async function carregarHistoricoParaAcompanhamento(nomePaciente) {
      if (!nomePaciente || tipoConsultaSelecionado !== 'acompanhamento') return;

      try {
        const res = await fetch(`${scriptURL}?action=buscarHistoricoCompleto&amp;nome=${encodeURIComponent(nomePaciente)}`);
        if (!res.ok) throw new Error('Erro de rede');
        const data = await res.json();
        const sessoes = data.historico || [];

        if (sessoes.length === 0) {
          historicoTextarea.value = '(Nenhum hist√≥rico anterior encontrado)';
          return;
        }

        // Monta o hist√≥rico completo formatado
        let historicoCompleto = '';
        sessoes.forEach((sessao, index) => {
          const dataConsulta = sessao.dataConsulta || '(sem data)';
          const status = sessao.statusConsulta || 'N√£o informado';
          const historico = sessao.historico || '(vazio)';
          const evolucao = sessao.evolucao || '(vazio)';

          historicoCompleto += `üìÖ Sess√£o ${index + 1} - ${dataConsulta} (${status})\n`;
          historicoCompleto += `Hist√≥rico: ${historico}\n`;
          historicoCompleto += `Evolu√ß√£o: ${evolucao}\n`;
          historicoCompleto += `\n${'='.repeat(60)}\n\n`;
        });

        historicoTextarea.value = historicoCompleto.trim();

      } catch (err) {
        console.error('Erro ao carregar hist√≥rico:', err);
        historicoTextarea.value = '(Erro ao carregar hist√≥rico anterior)';
      }
    }

    // Listener para carregar hist√≥rico quando mudar o paciente em modo acompanhamento
    nomeSessao.addEventListener('change', async function() {
      if (tipoConsultaSelecionado === 'acompanhamento' &amp;&amp; this.value) {
        await carregarHistoricoParaAcompanhamento(this.value);
      }
    });

    /* ---------------------------
       Data / fetch functions
       --------------------------- */
    async function atualizarListaDeNomes() {
      carregando.innerText = 'Carregando pacientes...';
      carregando.style.display = 'block';
      try {
        const res = await fetch(`${scriptURL}?action=listarPacientes`);
        if (!res.ok) throw new Error('Erro de rede');
        const data = await res.json();
        const nomes = [...new Set(data.map(p => p.nome))].sort((a,b)=>a.localeCompare(b,'pt-BR'));

        nomeSessao.innerHTML = '<option value="">Selecione</option>';
        historicoSelect.innerHTML = '<option value="">Selecione</option>';
        document.getElementById('frequenciaPaciente').innerHTML = '<option value="">Todos os pacientes</option>';

        nomes.forEach(n => {
          const opt1 = document.createElement('option'); opt1.value = n; opt1.textContent = n;
          const opt2 = document.createElement('option'); opt2.value = n; opt2.textContent = n;
          const opt3 = document.createElement('option'); opt3.value = n; opt3.textContent = n;
          nomeSessao.appendChild(opt1);
          historicoSelect.appendChild(opt2);
          document.getElementById('frequenciaPaciente').appendChild(opt3);
        });
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar pacientes. Verifique a URL do Apps Script e permiss√µes.');
      } finally {
        carregando.style.display = 'none';
      }
    }

    async function verHistorico() {
      const nome = historicoSelect.value;
      if (!nome) { painel.innerHTML = '<p style="color:var(--muted)">Selecione um paciente.</p>'; return; }
      painel.innerHTML = '<p style="color:var(--muted)">Buscando hist√≥rico...</p>';
      try {
        const res = await fetch(`${scriptURL}?action=buscarHistoricoCompleto&amp;nome=${encodeURIComponent(nome)}`);
        if (!res.ok) throw new Error('Erro de rede');
        const data = await res.json();
        const sessoes = data.historico || [];
        if (!sessoes.length) { painel.innerHTML = `<p style="color:var(--muted)">Nenhum hist√≥rico encontrado para ${nome}.</p>`; return; }
        painel.innerHTML = sessoes.map(sessao => {
          const dataConsulta = sessao.dataConsulta || '(sem data)';
          const status = sessao.statusConsulta || 'N√£o informado';
          const statusClass = status.toLowerCase().replace(/\s/g, '');
          return `<div class="session-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:700;color:var(--text-dark)">üìÖ ${dataConsulta}</div>
              <span class="status-badge status-${statusClass}">${status}</span>
            </div>
            <div style="margin-top:6px;color:var(--muted)"><strong>Hist√≥rico:</strong> ${sessao.historico || '(vazio)'}</div>
            <div style="margin-top:6px;color:var(--muted)"><strong>Evolu√ß√£o:</strong> ${sessao.evolucao || '(vazio)'}</div>
          </div>`;
        }).join('');
      } catch (err) {
        console.error(err);
        painel.innerHTML = `<p style="color:var(--muted)">Erro ao buscar hist√≥rico.</p>`;
      }
    }

    /* ---------------------------
       Frequ√™ncia
       --------------------------- */
    async function atualizarFrequencia() {
      const paciente = document.getElementById('frequenciaPaciente').value;
      const mes = document.getElementById('frequenciaMes').value;
      const ano = document.getElementById('frequenciaAno').value;

      try {
        const res = await fetch(`${scriptURL}?action=buscarHistoricoCompleto&amp;nome=${encodeURIComponent(paciente || '')}`);
        if (!res.ok) throw new Error('Erro de rede');
        const data = await res.json();
        let sessoes = data.historico || [];

        // Se n√£o tem paciente espec√≠fico, buscar todas as sess√µes
        if (!paciente) {
          const resAll = await fetch(`${scriptURL}?action=listarPacientes`);
          const allData = await resAll.json();
          sessoes = [];
          for (const p of allData) {
            const resPac = await fetch(`${scriptURL}?action=buscarHistoricoCompleto&amp;nome=${encodeURIComponent(p.nome)}`);
            const pacData = await resPac.json();
            if (pacData.historico) {
              pacData.historico.forEach(s => {
                s.nomePaciente = p.nome;
                sessoes.push(s);
              });
            }
          }
        } else {
          sessoes.forEach(s => s.nomePaciente = paciente);
        }

        // Filtrar por m√™s e ano
        if (mes || ano) {
          sessoes = sessoes.filter(s => {
            if (!s.dataConsulta) return false;
            const date = new Date(s.dataConsulta);
            if (mes &amp;&amp; (date.getMonth() + 1) !== parseInt(mes)) return false;
            if (ano &amp;&amp; date.getFullYear() !== parseInt(ano)) return false;
            return true;
          });
        }

        // Atualizar stats
        const total = sessoes.length;
        const compareceu = sessoes.filter(s => s.statusConsulta === 'Compareceu').length;
        const faltou = sessoes.filter(s => s.statusConsulta === 'Faltou').length;
        const reagendou = sessoes.filter(s => s.statusConsulta === 'Reagendou').length;

        document.getElementById('statTotal').textContent = total;
        document.getElementById('statCompareceu').textContent = compareceu;
        document.getElementById('statFaltou').textContent = faltou;
        document.getElementById('statReagendou').textContent = reagendou;

        // Atualizar tabela
        const tbody = document.getElementById('frequenciaTableBody');
        if (sessoes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted)">Nenhuma consulta encontrada</td></tr>';
        } else {
          tbody.innerHTML = sessoes.map(s => {
            const status = s.statusConsulta || 'N√£o informado';
            const statusClass = status.toLowerCase().replace(/\s/g, '');
            const tipo = s.tipoConsulta === 'primeira' ? 'Primeira Consulta' : 'Acompanhamento';
            return `<tr>
              <td>${s.dataConsulta || 'Sem data'}</td>
              <td>${s.nomePaciente || 'Sem nome'}</td>
              <td><span class="status-badge status-${statusClass}">${status}</span></td>
              <td>${tipo}</td>
            </tr>`;
          }).join('');
        }

        // Atualizar gr√°fico
        atualizarGrafico(sessoes);

      } catch (err) {
        console.error('Erro ao atualizar frequ√™ncia:', err);
        alert('Erro ao carregar dados de frequ√™ncia.');
      }
    }

    function atualizarGrafico(sessoes) {
      // Agrupar por m√™s
      const mesesData = {};
      sessoes.forEach(s => {
        if (!s.dataConsulta) return;
        const date = new Date(s.dataConsulta);
        const mesAno = `${date.getMonth() + 1}/${date.getFullYear()}`;
        if (!mesesData[mesAno]) {
          mesesData[mesAno] = { compareceu: 0, faltou: 0, reagendou: 0 };
        }
        const status = s.statusConsulta || '';
        if (status === 'Compareceu') mesesData[mesAno].compareceu++;
        else if (status === 'Faltou') mesesData[mesAno].faltou++;
        else if (status === 'Reagendou') mesesData[mesAno].reagendou++;
      });

      const labels = Object.keys(mesesData).sort();
      const compareceuData = labels.map(l => mesesData[l].compareceu);
      const faltouData = labels.map(l => mesesData[l].faltou);
      const reagendouData = labels.map(l => mesesData[l].reagendou);

      const ctx = document.getElementById('frequenciaChart');
      if (frequenciaChart) {
        frequenciaChart.destroy();
      }

      frequenciaChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Compareceu',
              data: compareceuData,
              backgroundColor: '#10b981',
              borderColor: '#059669',
              borderWidth: 1
            },
            {
              label: 'Faltou',
              data: faltouData,
              backgroundColor: '#ef4444',
              borderColor: '#dc2626',
              borderWidth: 1
            },
            {
              label: 'Reagendou',
              data: reagendouData,
              backgroundColor: '#f59e0b',
              borderColor: '#d97706',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }

    // Preencher anos no select
    function preencherAnos() {
      const anoSelect = document.getElementById('frequenciaAno');
      const anoAtual = new Date().getFullYear();
      for (let i = anoAtual; i >= anoAtual - 5; i--) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        anoSelect.appendChild(opt);
      }
    }

    /* ---------------------------
       Forms
       --------------------------- */
    formPaciente.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formPaciente);
      fd.append('action','cadastrarPaciente');
      try {
        const res = await fetch(scriptURL, { method:'POST', body: fd });
        const data = await res.json();
        if (data.sucesso) {
          alert('Paciente cadastrado com sucesso!');
          formPaciente.reset();
          await atualizarListaDeNomes();
        } else {
          throw new Error(data.erro || 'Erro ao cadastrar');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao cadastrar paciente: ' + err.message);
      }
    });

    formSessao.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(formSessao);
      fd.append('action','registrarSessao');
      const nomeSel = formSessao.elements.nome.value;
      try {
        const res = await fetch(scriptURL, { method:'POST', body: fd });
        const data = await res.json();
        if (data.sucesso) {
          alert('Sess√£o registrada com sucesso!');
          formSessao.reset();
          historicoTextarea.value = '';
          selecionarTipoConsulta('primeira');

          if (document.getElementById('historico').style.display !== 'none' &amp;&amp; historicoSelect.value === nomeSel) {
            await verHistorico();
          }
        } else {
          throw new Error(data.erro || 'Erro ao salvar sess√£o');
        }
      } catch (err) {
        console.error(err);
        alert('Erro ao registrar sess√£o: ' + err.message);
      }
    });

    /* ---------------------------
       PDF export (jsPDF)
       --------------------------- */
    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const nome = historicoSelect.value || 'Paciente';
      if (!historicoSelect.value) { alert('Selecione um paciente para exportar.'); return; }
      if (painel.innerHTML.trim() === '' || painel.innerHTML.includes('Selecione um paciente') || painel.innerHTML.includes('Nenhum hist√≥rico')) {
        await verHistorico();
      }

      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const margin = 40;
      let y = 60;
      doc.setFont('Helvetica','bold');
      doc.setFontSize(16);
      doc.text(`Hist√≥rico Psicol√≥gico ‚Äî ${nome}`, margin, y);
      y += 20;
      doc.setFontSize(10);
      doc.setFont('Helvetica','normal');

      const cards = document.querySelectorAll('.session-card');
      if (!cards.length) { alert('Nenhuma sess√£o dispon√≠vel para exportar.'); return; }

      cards.forEach((card, idx) => {
        const lines = card.innerText.split('\n').map(l => l.trim()).filter(Boolean);
        doc.setFont('Helvetica','bold');
        doc.setFontSize(12);
        lines.forEach(line => {
          const split = doc.splitTextToSize(line, 520);
          if (y + (split.length * 12) > 800) { doc.addPage(); y = 60; }
          doc.text(split, margin, y);
          y += (split.length * 12) + 6;
        });
        y += 4;
      });

      doc.save(`Historico_${nome.replace(/\s+/g,'_')}.pdf`);
    }

    /* ---------------------------
       Auth (Firebase)
       --------------------------- */
    function loginGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => alert('Erro ao logar: ' + err.message));
    }

    function logoutGoogle() {
      auth.signOut().then(() => {
        alert('Voc√™ saiu do sistema.');
      }).catch(err => alert('Erro ao sair: ' + err.message));
    }

    auth.onAuthStateChanged(user => {
      carregando.style.display = 'none';
      if (user) {
        document.getElementById('loginCard').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        document.getElementById('topbar').style.display = 'flex';
        document.getElementById('userEmail').textContent = user.email || '';
        const avatar = document.getElementById('userAvatar');
        document.getElementById('userName').textContent = user.displayName || '';
        if (user.photoURL) avatar.style.backgroundImage = `url(${user.photoURL})`;
        else avatar.textContent = (user.displayName || 'U').charAt(0).toUpperCase();

        atualizarListaDeNomes();
        preencherAnos();
        setActiveNav(btnPaciente);
        showTab('paciente');
      } else {
        document.getElementById('loginCard').style.display = 'block';
        document.getElementById('appContent').style.display = 'none';
        document.getElementById('topbar').style.display = 'none';
        document.getElementById('userEmail').textContent = ' ‚Äî ';
      }
    });

    window.loginGoogle = loginGoogle;
    window.logoutGoogle = logoutGoogle;
    window.verHistorico = verHistorico;
    window.exportarPDF = exportarPDF;
    window.toggleSidebar = toggleSidebar;
    window.selecionarTipoConsulta = selecionarTipoConsulta;
    window.atualizarFrequencia = atualizarFrequencia;

    document.getElementById('btn-paciente').addEventListener('click', () => { setActiveNav(btnPaciente); showTab('paciente'); });
    document.getElementById('btn-sessao').addEventListener('click', () => { setActiveNav(btnSessao); showTab('sessao'); });
    document.getElementById('btn-historico').addEventListener('click', () => { setActiveNav(btnHistorico); showTab('historico'); });
    document.getElementById('btn-frequencia').addEventListener('click', () => { setActiveNav(btnFrequencia); showTab('frequencia'); });

    historicoSelect.addEventListener('change', () => {
      if (document.getElementById('historico').style.display !== 'none') verHistorico();
    });
  </script>
</body>
</html>
