/ =======================================================
// CONFIGURAÇÃO DO SISTEMA
// =======================================================

// Substitua pelo ID da sua planilha (ex: 1zYp...)
const SPREADSHEET_ID = 'SEU_ID_DA_PLANILHA_AQUI'; 
const CLIENTES_SHEET_NAME = 'Clientes';
const SESSOES_SHEET_NAME = 'Sessões';

// Substitua pelo ID do seu calendário (Ex: c_1a2b3c4d5e6f7g8h9i0jkl@group.calendar.google.com)
// Você pode encontrar o ID nas configurações do seu Google Calendar.
const CALENDAR_ID = 'SEU_ID_DO_GOOGLE_CALENDAR_AQUI'; 

// =======================================================
// FUNÇÃO PRINCIPAL
// =======================================================

function doGet(e) {
  const action = e.parameter.action;
  
  if (action === 'getAgenda') {
    return handleGetAgenda(e);
  }
  if (action === 'listarPacientes') {
    return handleListarPacientes(); // Mantém a listagem de clientes do Sheets
  }
  // Se for um request GET de clientes (Busca por CPF), redireciona para Sheets (seria ideal que o front usasse POST)
  if (action === 'buscarPaciente') { 
    return handleBuscarPaciente(e);
  }
  
  // Se for a página inicial, serve o HTML (você deve publicar este script como Web App)
  return HtmlService.createTemplateFromFile('index').evaluate();
}

function doPost(e) {
  const action = e.parameter.action;

  if (action === 'createEvent') {
    return handleCreateEvent(e);
  }
  if (action === 'deleteEvent') {
    return handleDeleteEvent(e);
  }
  if (action === 'cadastrarPaciente') {
    return handleCadastrarPaciente(e); // Mantém o cadastro de clientes do Sheets
  }
  if (action === 'registrarSessao') {
    return handleRegistrarSessao(e); // Mantém o registro de sessões do Sheets
  }
  
  return jsonResponse({ erro: 'Ação POST não reconhecida.' });
}

// =======================================================
// FUNÇÕES DE AGENDA (Google Calendar API)
// =======================================================

function handleGetAgenda(e) {
  try {
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    if (!calendar) {
      return jsonResponse({ erro: 'Calendário não encontrado. Verifique o CALENDAR_ID.' });
    }

    const start = new Date(e.parameter.start);
    const end = new Date(e.parameter.end);

    // Busca todos os eventos na faixa de datas
    const events = calendar.getEvents(start, end);
    
    // Mapeia eventos para o formato que o FullCalendar entende
    const formattedEvents = events.map(event => {
      // Usa uma descrição simples para identificar o tipo de evento (Bloqueio vs Agendamento)
      const eventTitle = event.getTitle() || '';
      let type = 'AGENDAMENTO';
      if (eventTitle.toUpperCase().includes('BLOQUEIO')) {
          type = 'BLOQUEIO';
      }
      
      return {
        id: event.getId(),
        title: eventTitle,
        start: event.getStartTime().toISOString(),
        end: event.getEndTime().toISOString(),
        type: type,
        // color: (type === 'BLOQUEIO' ? 'red' : 'blue') // Cor é definida no Front-End
      };
    });

    return jsonResponse(formattedEvents);

  } catch (error) {
    Logger.log('Erro no handleGetAgenda: ' + error.toString());
    return jsonResponse({ erro: 'Falha ao buscar agenda. ' + error.message });
  }
}

function handleCreateEvent(e) {
  try {
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    const id = e.parameter.id;
    const title = e.parameter.title;
    const start = new Date(e.parameter.start);
    const end = new Date(e.parameter.end);
    const type = e.parameter.type;
    
    if (id) {
      // Modificar Evento Existente
      const event = calendar.getEventById(id);
      if (!event) return jsonResponse({ erro: 'Evento não encontrado para modificação.' });
      
      event.setTitle(title);
      event.setTime(start, end);
      
    } else {
      // Criar Novo Evento
      calendar.createEvent(title, start, end);
    }

    return jsonResponse({ sucesso: true });

  } catch (error) {
    Logger.log('Erro no handleCreateEvent: ' + error.toString());
    return jsonResponse({ erro: 'Falha ao salvar evento. ' + error.message });
  }
}

function handleDeleteEvent(e) {
  try {
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    const id = e.parameter.id;

    const event = calendar.getEventById(id);
    if (!event) {
      return jsonResponse({ erro: 'Evento não encontrado para exclusão.' });
    }

    event.deleteEvent();

    return jsonResponse({ sucesso: true });

  } catch (error) {
    Logger.log('Erro no handleDeleteEvent: ' + error.toString());
    return jsonResponse({ erro: 'Falha ao excluir evento. ' + error.message });
  }
}


// =======================================================
// FUNÇÕES DE CLIENTES E SESSÕES (Google Sheets API)
// =======================================================

// As funções de Sheets (handleBuscarPaciente, handleCadastrarPaciente, etc.) 
// devem ser mantidas aqui, usando SpreadsheetApp.getSpreadsheetById(SPREADSHEET_ID).

// ... (COLE AQUI O SEU CÓDIGO ANTERIOR DE MANUSEIO DE CLIENTES E SESSÕES, GARANTINDO QUE ELE USE SpreadsheetApp) ...


// =======================================================
// FUNÇÃO DE UTILIDADE
// =======================================================

function jsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
